services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "9876:9876"  # API port (host:container)
    volumes:
      - ./data:/app/data
      - ./.env:/app/.env:ro
    environment:
      - DATABASE_PATH=data/medley.db
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-9876}
    restart: unless-stopped
    command: >
      sh -c "
        exec uvicorn api.main:app --host $${API_HOST:-0.0.0.0} --port $${API_PORT:-9876}
      "

  streamlit:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "9877:9877"  # Streamlit port (host:container)
    volumes:
      - ./data:/app/data
      - ./.env:/app/.env:ro
    environment:
      - STREAMLIT_HOST=${STREAMLIT_HOST:-0.0.0.0}
      - STREAMLIT_PORT=${STREAMLIT_PORT:-9877}
      - API_URL=${API_URL:-http://api:9876}  # Use service name in Docker, override via env var
    restart: unless-stopped
    command: streamlit run ui/app.py --server.port ${STREAMLIT_PORT:-9877} --server.address ${STREAMLIT_HOST:-0.0.0.0} --server.headless=true


